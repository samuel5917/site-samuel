<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>S-systems</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
  :root {
    --vio1:#171236;
    --vio2:#433E7C;
    --vio3:#8C75C7;
    --vio4:#B68AD9;
    --vio5:#E4B0D0;

    --accent:#0ea5e9;
    --accent-soft:#082f49;
    --muted:#94a3b8;

    --bg-main:#111827;
  }

  *{
    box-sizing:border-box;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif
  }

  body{
    margin:0;
    min-height:100vh;
    background:radial-gradient(circle at top,#1f2937 0,var(--bg-main) 60%,#020617 100%);
    color:#e5e7eb;
    padding:16px;
    display:flex;
    flex-direction:column;
    overflow-x: hidden;
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    width:100%;
    display:flex;
    flex-direction:column;
    gap:16px;
    transition: transform 0.3s ease;
  }

  header{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 16px;
    border-radius:16px;
    background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(67,62,124,0.75));
    border:1px solid rgba(148,163,184,0.45);
    box-shadow:0 18px 40px rgba(0,0,0,0.55);
    backdrop-filter:blur(20px);
  }

  /* MENU HAMBURGER */
  .menu-btn {
    background: none;
    border: none;
    color: #e5e7eb;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.2s;
  }
  .menu-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100%;
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(148, 163, 184, 0.3);
    z-index: 100;
    transition: left 0.3s ease;
    padding: 20px;
    box-shadow: 10px 0 30px rgba(0,0,0,0.5);
  }
  .sidebar.open {
    left: 0;
  }
  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    padding-bottom: 15px;
  }
  .sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 99;
  }
  .sidebar-overlay.show {
    display: block;
  }

  .logo-img{
    height:56px;
  }
  .title-area h1{margin:0;font-size:22px;}
  .title-area p{margin:4px 0 0;font-size:13px;color:var(--muted);}

  .db-status{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    color:var(--muted);
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,0.7);
    border:1px solid rgba(148,163,184,0.35);
  }
  .db-dot{
    width:10px;
    height:10px;
    border-radius:999px;
    background:#22c55e;
    box-shadow:0 0 8px rgba(34,197,94,0.7);
  }
  .db-dot.offline{
    background:#ef4444;
    box-shadow:0 0 8px rgba(239,68,68,0.7);
  }

  .card{
    border-radius:18px;
    padding:16px 18px;
    box-shadow:0 18px 40px rgba(0,0,0,0.45);
    background:rgba(15,23,42,0.75);
    border:1px solid rgba(148,163,184,0.35);
    backdrop-filter:blur(16px);
  }
  .card h2{
    margin:0 0 8px;
    font-size:18px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .card h2::before{
    content:"";
    width:4px;
    height:18px;
    border-radius:999px;
    background:linear-gradient(to bottom,var(--accent),var(--vio3));
  }

  .card-registro{
    background:linear-gradient(135deg,rgba(67,62,124,0.55),rgba(182,138,217,0.22));
    border:1px solid rgba(182,138,217,0.85);
  }

  label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px;}
  input,select,textarea{
    width:100%;
    padding:9px 11px;
    border-radius:10px;
    border:1px solid rgba(148,163,184,0.4);
    background:rgba(15,23,42,0.85);
    color:#e5e7eb;
    font-size:14px;
    backdrop-filter:blur(10px);
  }
  textarea{
    min-height:80px;
    resize:vertical;
    font-family:inherit;
  }
  input::placeholder,textarea::placeholder{ color:rgba(148,163,184,0.7); }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(14,165,233,0.5);
  }
  .row{display:flex;flex-wrap:wrap;gap:12px;}
  .col{flex:1 1 200px;}

  .btn{
    border:none;
    border-radius:999px;
    padding:9px 16px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition:transform .08s ease, box-shadow .08s ease, background .15s ease;
  }
  .btn:active{ transform:scale(0.97); box-shadow:none; }
  .btn-primary{
    background:var(--accent);
    color:#020617;
    box-shadow:0 10px 25px rgba(14,165,233,0.35);
  }
  .btn-primary:hover{background:#0284c7;}
  .btn-ghost{
    background:rgba(15,23,42,0.6);
    color:var(--accent);
    border:1px solid rgba(148,163,184,0.5);
    backdrop-filter:blur(12px);
  }
  .btn-ghost:hover{background:var(--accent-soft);}
  .btn-danger,.btn-delete{
    background:rgba(15,23,42,0.8);
    color:#f97316;
    border:1px solid rgba(248,113,113,0.55);
    border-radius:999px;
    padding:4px 10px;
    font-size:11px;
    cursor:pointer;
  }
  .btn-delete{ padding:4px 8px; }
  .btn-danger:hover,.btn-delete:hover{ background:rgba(248,113,113,0.16); }

  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:11px;
    background:rgba(15,23,42,0.8);
    border:1px solid rgba(148,163,184,0.4);
    color:var(--muted);
    backdrop-filter:blur(12px);
  }
  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
  th,td{ padding:6px 8px; text-align:left; }
  thead{ background:rgba(15,23,42,0.95); }
  tbody tr:nth-child(odd){background:rgba(15,23,42,0.9);}
  tbody tr:nth-child(even){background:rgba(15,23,42,0.75);}
  th{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    border-bottom:1px solid rgba(148,163,184,0.4);
  }
  td{ border-bottom:1px dashed rgba(30,64,175,0.4); }
  .pill-turno{
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:600;
    background:rgba(34,197,94,0.1);
    color:#bbf7d0;
  }
  .pill-turno2{
    background:rgba(249,115,22,0.12);
    color:#fed7aa;
  }
  footer{
    margin-top:auto;
    font-size:10px;
    color:var(--muted);
    text-align:right;
    padding:4px 2px 0;
  }

  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:150;
    backdrop-filter:blur(4px);
  }
  .modal-content{
    background:rgba(15,23,42,0.95);
    border-radius:16px;
    padding:20px;
    border:1px solid rgba(148,163,184,0.4);
    width:100%;
    max-width:520px;
    box-shadow:0 18px 40px rgba(0,0,0,0.7);
    backdrop-filter:blur(20px);
    max-height:90vh;
    overflow-y:auto;
  }
  .modal-large{ max-width:900px; }

  .image-preview{
    margin-top:8px;
    max-width:100%;
    border-radius:8px;
    border:1px solid rgba(148,163,184,0.4);
  }
  .image-preview img{
    max-width:100%;
    height:auto;
    display:block;
    border-radius:8px;
  }

  .image-thumbnail{
    width:60px;
    height:60px;
    object-fit:cover;
    border-radius:6px;
    border:1px solid rgba(148,163,184,0.4);
    cursor:pointer;
  }

  .file-input-wrapper{
    position:relative;
    display:inline-block;
    width:100%;
  }
  .file-input-wrapper input[type="file"]{
    position:absolute;
    opacity:0;
    width:100%;
    height:100%;
    cursor:pointer;
  }
  .file-input-label{
    display:block;
    padding:9px 11px;
    border-radius:10px;
    border:1px solid rgba(148,163,184,0.4);
    background:rgba(15,23,42,0.85);
    color:var(--muted);
    font-size:14px;
    cursor:pointer;
    text-align:center;
  }
  .file-input-label:hover{
    border-color:var(--accent);
  }

  @media(max-width:768px){
    body{padding:10px;}
    .page{gap:12px;}
    header{flex-direction:row;align-items:center;}
    .db-status{display:none;}
    .card{padding:12px 13px;}
  }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
</head>

<body>
<script>
// Se NÃO veio do login.html, volta para login
if (!document.referrer.includes("login.html")) {
  window.location.href = "login.html";
}
</script>

<!-- SIDEBAR -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <h3 style="margin:0; color:var(--accent);">Menu</h3>
    <button id="btnCloseSidebar" class="menu-btn">✕</button>
  </div>
  <div style="color:var(--muted); font-size:14px; text-align:center; margin-top:50px;">
    Menu em desenvolvimento...
  </div>
</div>

<div class="page">
<header>
  <button id="btnOpenSidebar" class="menu-btn">☰</button>
  <div class="title-area">
    <h1>PAINEL DE APOIO OPERACIONAL</h1>
    <p>Sistema para registrar carretas contaminadas e controlar notas fiscais canceladas</p>
  </div>
  <div class="db-status">
    <span class="db-dot offline" id="dbDot"></span>
    <span id="dbStatusText">Banco de dados: verificando...</span>
  </div>
</header>

<section class="card card-registro">
  <h2>REGISTRO CARRETAS CONTAMINADAS</h2>
  <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
    <div class="tag">
      <span>TURNOS:</span>
      <span><strong>Turno 1</strong> 07:00 → 19:00 </span> ·
      <span><strong>Turno 2</strong> 19:00 → 07:00 </span>
    </div>
    <!-- BOTÃO NA DIREITA -->
    <button id="btnAbrirModalCarreta" class="btn btn-primary" type="button" style="margin-left:auto;">
      + Registrar caminhão sujo
    </button>
  </div>

  <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
    <button id="btnAbrirRegistros" class="btn btn-ghost" type="button">
      Últimos registros (24h)
    </button>
    <button id="btnAbrirRelatorio" class="btn btn-ghost" type="button">
      Relatórios Báscula / PDF + Gráfico
    </button>
  </div>
</section>

<section class="card card-registro">
  <h2>REGISTRO NF-E CANCELADAS</h2>

  <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnAbrirNF24h" class="btn btn-ghost" type="button">
        Últimas NF (24h)
      </button>
      <button id="btnAbrirRelatorioNF" class="btn btn-ghost" type="button">
        Relatórios NF / PDF + Gráfico
      </button>
    </div>
    <!-- BOTÃO NA DIREITA -->
    <button id="btnAbrirModalNF" class="btn btn-primary" type="button" style="margin-left:auto;">
      + Registrar NF cancelada
    </button>
  </div>
</section>

<footer>
  <span>Samuel Nascimento de Jesus</span>
</footer>
</div>

<!-- MODAIS -->
<!-- MODAL: ADICIONAR TRANSPORTADORA -->
<div id="modalAddTransp" class="modal-backdrop">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h3 style="margin:0;font-size:16px;">Nova transportadora</h3>
      <button id="btnFecharAddTransp" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <label for="nomeNovaTransp">Nome da transportadora</label>
    <input id="nomeNovaTransp" maxlength="60" placeholder="Digite o nome">
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button id="btnSalvarTransp" class="btn btn-primary" type="button">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL: REGISTRAR CARRETA CONTAMINADA -->
<div id="modalCarreta" class="modal-backdrop">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h3 style="margin:0;font-size:16px;">Registrar Carreta Contaminada</h3>
      <button id="btnFecharModalCarreta" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    
    <div class="row">
      <div class="col">
        <label for="placaModal">Placa do veículo</label>
        <input id="placaModal" maxlength="10" placeholder="Ex: RST1A23" autocomplete="off">
      </div>
      <div class="col">
        <label for="transportadoraModal">Transportadora</label>
        <select id="transportadoraModal"></select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="imagemCarreta">Imagem da carreta (opcional)</label>
      <div class="file-input-wrapper">
        <input type="file" id="imagemCarreta" accept="image/*">
        <label class="file-input-label" for="imagemCarreta">Clique para selecionar imagem</label>
      </div>
      <div id="previewImagemCarreta" class="image-preview" style="display:none;">
        <img id="imgPreviewCarreta" src="" alt="Preview">
      </div>
    </div>

    <div style="margin-top:16px;display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <button id="btnAddTranspModal" class="btn btn-ghost" type="button">+ Nova transportadora</button>
      <button id="btnSalvarCarreta" class="btn btn-primary" type="button">Salvar registro</button>
    </div>
  </div>
</div>

<!-- MODAL: REGISTRAR NF CANCELADA -->
<div id="modalNF" class="modal-backdrop">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h3 style="margin:0;font-size:16px;">Registrar NF Cancelada</h3>
      <button id="btnFecharModalNF" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    
    <div class="row">
      <div class="col">
        <label for="placaNFModal">Placa do veículo</label>
        <input id="placaNFModal" maxlength="10" placeholder="Ex: RST1A23" autocomplete="off">
      </div>
      <div class="col">
        <label for="transportadoraNFModal">Transportadora</label>
        <select id="transportadoraNFModal"></select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label for="nfCanceladaModal">NF Cancelada</label>
        <input id="nfCanceladaModal" maxlength="20" placeholder="Número da NF cancelada">
      </div>
      <div class="col">
        <label for="nfSubstitutaModal">NF Substituta</label>
        <input id="nfSubstitutaModal" maxlength="20" placeholder="Número da NF substituta">
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="motivoCancelamentoModal">Motivo do cancelamento</label>
      <textarea id="motivoCancelamentoModal" maxlength="200" placeholder="EX: ERRO DE LANÇAMENTO, ERRO DE MATERIAL, ETC..."></textarea>
    </div>

    <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
      <button id="btnSalvarNF" class="btn btn-primary" type="button">Salvar vínculo NF</button>
    </div>
  </div>
</div>

<!-- MODAL: ÚLTIMOS REGISTROS BÁSCULA -->
<div id="modalRegistros" class="modal-backdrop">
  <div class="modal-content modal-large">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Últimos registros (apenas últimas 24h)</h3>
      <button id="btnFecharRegistros" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Data/Hora real</th>
            <th>Turno</th>
            <th>Placa</th>
            <th>Transportadora</th>
            <th>Imagem</th>
            <th style="width:70px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL: ÚLTIMAS NF (24h) -->
<div id="modalNF24h" class="modal-backdrop">
  <div class="modal-content modal-large">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Últimas NF Canceladas x Substitutas (24h)</h3>
      <button id="btnFecharNF24h" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data/Hora</th>
            <th>Placa</th>
            <th>Transportadora</th>
            <th>NF Cancelada</th>
            <th>NF Substituta</th>
            <th>Motivo do cancelamento</th>
          </tr>
        </thead>
        <tbody id="tbodyNF24h"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL: RELATÓRIO BÁSCULA -->
<div id="modalRelatorio" class="modal-backdrop">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Relatórios Báscula / PDF + Gráfico</h3>
      <button id="btnFecharRelatorio" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <div class="row">
      <div class="col">
        <label for="inicioRel">Início do período</label>
        <input id="inicioRel" type="datetime-local">
      </div>
      <div class="col">
        <label for="fimRel">Fim do período</label>
        <input id="fimRel" type="datetime-local">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnRelatorioPdf" class="btn btn-primary" type="button">Gerar PDF</button>
      <button id="btnGrafico7d" class="btn btn-ghost" type="button">Gráfico 7 dias</button>
    </div>
    <p id="msgRel" style="font-size:12px;color:var(--muted);margin-top:6px;"></p>
  </div>
</div>

<!-- MODAL: RELATÓRIO NF -->
<div id="modalRelatorioNF" class="modal-backdrop">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Relatórios NF</h3>
      <button id="btnFecharRelatorioNF" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <div class="row">
      <div class="col">
        <label for="inicioRelNF">Início do período</label>
        <input id="inicioRelNF" type="datetime-local">
      </div>
      <div class="col">
        <label for="fimRelNF">Fim do período</label>
        <input id="fimRelNF" type="datetime-local">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnRelatorioPdfNF" class="btn btn-primary" type="button">Gerar PDF NF</button>
      <button id="btnGrafico7dNF" class="btn btn-ghost" type="button">Gráfico NF</button>
    </div>
    <p id="msgRelNF" style="font-size:12px;color:var(--muted);margin-top:6px;"></p>
  </div>
</div>

<!-- MODAIS GRÁFICOS -->
<div id="modalGrafico" class="modal-backdrop">
  <div class="modal-content modal-large">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Gráfico Carretas</h3>
      <button id="btnFecharModalGrafico" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <canvas id="grafico7d" style="width:100%;max-height:320px;"></canvas>
  </div>
</div>

<div id="modalGraficoNF" class="modal-backdrop">
  <div class="modal-content modal-large">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font-size:16px;">Gráfico NF</h3>
      <button id="btnFecharModalGraficoNF" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <canvas id="grafico7dNFCanvas" style="width:100%;max-height:320px;"></canvas>
  </div>
</div>

<!-- MODAL: VISUALIZAR IMAGEM -->
<div id="modalVisualizarImagem" class="modal-backdrop">
  <div class="modal-content modal-large">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h3 style="margin:0;font-size:16px;">Imagem da Carreta</h3>
      <button id="btnFecharModalImagem" class="btn-danger btn-close" type="button">Fechar</button>
    </div>
    <div style="text-align:center;">
      <img id="imagemGrande" src="" alt="Imagem" style="max-width:100%;height:auto;border-radius:8px;">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://rficsflnaxayyrddxald.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_5oVEei3ZTGog0ycrbBbs2w_oDImnx9K";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== KEYS LOCAL ======
  const STORAGE_KEY_TRANSP   = "msa_balanca_suja_transportadoras_v1";
  const LS_KEY_REGISTROS     = "msa_registros_bascula_local_v1";
  const LS_KEY_NF_SUBSTITUTA = "msa_nf_substitutas_local_v1";

  let transportadoras = ["CAIO TRANSPORTES", "ECOMINING", "RODOMINAS"];
  let registrosCache  = [];
  let registrosLocal  = [];
  let nfLocal         = [];
  let nfCache         = [];

  // ====== ELEMENTOS ======
  const dbDot        = document.getElementById("dbDot");
  const dbStatusText = document.getElementById("dbStatusText");

  // Sidebar
  const sidebar = document.getElementById("sidebar");
  const sidebarOverlay = document.getElementById("sidebarOverlay");
  const btnOpenSidebar = document.getElementById("btnOpenSidebar");
  const btnCloseSidebar = document.getElementById("btnCloseSidebar");

  // Modais e Botões
  const modalCarreta = document.getElementById("modalCarreta");
  const btnAbrirModalCarreta = document.getElementById("btnAbrirModalCarreta");
  const btnFecharModalCarreta = document.getElementById("btnFecharModalCarreta");
  const placaModal = document.getElementById("placaModal");
  const transportadoraModal = document.getElementById("transportadoraModal");
  const imagemCarreta = document.getElementById("imagemCarreta");
  const previewImagemCarreta = document.getElementById("previewImagemCarreta");
  const imgPreviewCarreta = document.getElementById("imgPreviewCarreta");
  const btnSalvarCarreta = document.getElementById("btnSalvarCarreta");
  const btnAddTranspModal = document.getElementById("btnAddTranspModal");

  const modalNF = document.getElementById("modalNF");
  const btnAbrirModalNF = document.getElementById("btnAbrirModalNF");
  const btnFecharModalNF = document.getElementById("btnFecharModalNF");
  const placaNFModal = document.getElementById("placaNFModal");
  const transportadoraNFModal = document.getElementById("transportadoraNFModal");
  const nfCanceladaModal = document.getElementById("nfCanceladaModal");
  const nfSubstitutaModal = document.getElementById("nfSubstitutaModal");
  const motivoCancelamentoModal = document.getElementById("motivoCancelamentoModal");
  const btnSalvarNF = document.getElementById("btnSalvarNF");

  const modalAddTransp = document.getElementById("modalAddTransp");
  const btnFecharAddTransp = document.getElementById("btnFecharAddTransp");
  const nomeNovaTransp = document.getElementById("nomeNovaTransp");
  const btnSalvarTransp = document.getElementById("btnSalvarTransp");

  const modalRegistros = document.getElementById("modalRegistros");
  const btnAbrirRegistros = document.getElementById("btnAbrirRegistros");
  const btnFecharRegistros = document.getElementById("btnFecharRegistros");
  const tbodyRegistros = document.getElementById("tbodyRegistros");

  const modalNF24h = document.getElementById("modalNF24h");
  const btnAbrirNF24h = document.getElementById("btnAbrirNF24h");
  const btnFecharNF24h = document.getElementById("btnFecharNF24h");
  const tbodyNF24h = document.getElementById("tbodyNF24h");

  const modalRelatorio = document.getElementById("modalRelatorio");
  const btnAbrirRelatorio = document.getElementById("btnAbrirRelatorio");
  const btnFecharRelatorio = document.getElementById("btnFecharRelatorio");
  const inicioRel = document.getElementById("inicioRel");
  const fimRel = document.getElementById("fimRel");
  const btnRelatorioPdf = document.getElementById("btnRelatorioPdf");
  const msgRel = document.getElementById("msgRel");
  const btnGrafico7d = document.getElementById("btnGrafico7d");

  const modalRelatorioNF = document.getElementById("modalRelatorioNF");
  const btnAbrirRelatorioNF = document.getElementById("btnAbrirRelatorioNF");
  const btnFecharRelatorioNF = document.getElementById("btnFecharRelatorioNF");
  const inicioRelNF = document.getElementById("inicioRelNF");
  const fimRelNF = document.getElementById("fimRelNF");
  const btnRelatorioPdfNF = document.getElementById("btnRelatorioPdfNF");
  const msgRelNF = document.getElementById("msgRelNF");
  const btnGrafico7dNF = document.getElementById("btnGrafico7dNF");

  const modalGrafico = document.getElementById("modalGrafico");
  const btnFecharModalGrafico = document.getElementById("btnFecharModalGrafico");
  const canvasGrafico = document.getElementById("grafico7d");

  const modalGraficoNF = document.getElementById("modalGraficoNF");
  const btnFecharModalGraficoNF = document.getElementById("btnFecharModalGraficoNF");
  const canvasGraficoNF = document.getElementById("grafico7dNFCanvas");

  const modalVisualizarImagem = document.getElementById("modalVisualizarImagem");
  const btnFecharModalImagem = document.getElementById("btnFecharModalImagem");
  const imagemGrande = document.getElementById("imagemGrande");

  // ====== UTIL ======
  function setDbStatus(isOnline){
    if(isOnline){
      dbDot.classList.remove("offline");
      dbStatusText.textContent = "Banco de dados: ONLINE";
    }else{
      dbDot.classList.add("offline");
      dbStatusText.textContent = "Banco de dados: OFFLINE";
    }
  }

  const fpOpts = {
    enableTime: true,
    dateFormat: "Y-m-d\\TH:i",
    altInput: true,
    altFormat: "d/m/Y H:i",
    time_24hr: true,
    locale: flatpickr.l10ns.pt
  };
  flatpickr("#inicioRel", fpOpts);
  flatpickr("#fimRel", fpOpts);
  flatpickr("#inicioRelNF", fpOpts);
  flatpickr("#fimRelNF", fpOpts);

  function pad2(x){ return String(x).padStart(2,"0"); }

  function classificarTurno(d) {
    const ano = d.getFullYear();
    const mes = d.getMonth();
    const dia = d.getDate();
    function fmt(y, m, d2) {
      const mm = pad2(m + 1);
      const dd = pad2(d2);
      return `${y}-${mm}-${dd}`;
    }
    const inicioT1 = new Date(ano, mes, dia, 7, 0, 0);
    const fimT1 = new Date(ano, mes, dia, 18, 59, 59);
    const inicioT2 = new Date(ano, mes, dia, 19, 0, 0);
    const fimDia   = new Date(ano, mes, dia, 23, 59, 59);
    const inicioDia  = new Date(ano, mes, dia, 0, 0, 0);
    const fimAntes7  = new Date(ano, mes, dia, 6, 59, 59);
    if (d >= inicioT1 && d <= fimT1) return { turno: 1, diaTurno: fmt(ano, mes, dia) };
    if (d >= inicioT2 && d <= fimDia) return { turno: 2, diaTurno: fmt(ano, mes, dia) };
    if (d >= inicioDia && d <= fimAntes7) {
      const dAnt = new Date(d);
      dAnt.setDate(dAnt.getDate() - 1);
      return { turno: 2, diaTurno: fmt(dAnt.getFullYear(), dAnt.getMonth(), dAnt.getDate()) };
    }
    return { turno: 1, diaTurno: fmt(ano, mes, dia) };
  }

  function formatarDataHora(d) {
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    return `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
  }

  // ====== SIDEBAR ======
  function toggleSidebar() {
    sidebar.classList.toggle("open");
    sidebarOverlay.classList.toggle("show");
  }
  btnOpenSidebar.addEventListener("click", toggleSidebar);
  btnCloseSidebar.addEventListener("click", toggleSidebar);
  sidebarOverlay.addEventListener("click", toggleSidebar);

  // ====== TRANSPORTADORAS ======
  function carregarTransportadoras() {
    const stored = localStorage.getItem(STORAGE_KEY_TRANSP);
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed) && parsed.length > 0) transportadoras = parsed;
      } catch (e) { console.error(e); }
    }
    renderizarSelects();
  }
  function salvarTransportadoras() {
    localStorage.setItem(STORAGE_KEY_TRANSP, JSON.stringify(transportadoras));
  }
  function renderizarSelects() {
    [transportadoraModal, transportadoraNFModal].forEach(sel => {
      sel.innerHTML = '<option value="">-- Selecione --</option>';
      transportadoras.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });
    });
  }
  function adicionarTransportadora() {
    const nome = (nomeNovaTransp.value || "").trim().toUpperCase();
    if (!nome) return alert("Digite o nome.");
    if (transportadoras.includes(nome)) return alert("Já existe.");
    transportadoras.push(nome);
    transportadoras.sort();
    salvarTransportadoras();
    renderizarSelects();
    nomeNovaTransp.value = "";
    modalAddTransp.style.display = "none";
  }

  // ====== LOCAL STORAGE ======
  function carregarRegistrosLocal() {
    const stored = localStorage.getItem(LS_KEY_REGISTROS);
    if (stored) { try { registrosLocal = JSON.parse(stored); } catch (e) { console.error(e); } }
  }
  function salvarRegistrosLocal() {
    localStorage.setItem(LS_KEY_REGISTROS, JSON.stringify(registrosLocal));
  }
  function carregarNFLocal() {
    const stored = localStorage.getItem(LS_KEY_NF_SUBSTITUTA);
    if (stored) { try { nfLocal = JSON.parse(stored); } catch (e) { console.error(e); } }
  }
  function salvarNFLocal() {
    localStorage.setItem(LS_KEY_NF_SUBSTITUTA, JSON.stringify(nfLocal));
  }

  // ====== SUPABASE ======
  async function supaInsert(payload) {
    const { data, error } = await supabase.from("registros_bascula").insert([payload]);
    if (error) throw error;
    return data;
  }
  async function supaList() {
    const { data, error } = await supabase.from("registros_bascula").select("*").order("created_at", { ascending: false });
    if (error) throw error;
    return data || [];
  }
  async function supaDelete(id) {
    const { error } = await supabase.from("registros_bascula").delete().eq("id", id);
    if (error) throw error;
  }
  async function supaInsertNF(payload) {
    const { data, error } = await supabase.from("nf_substitutas").insert([payload]);
    if (error) throw error;
    return data;
  }
  async function supaListNF() {
    const { data, error } = await supabase.from("nf_substitutas").select("*").order("created_at", { ascending: false });
    if (error) throw error;
    return data || [];
  }

  async function syncPendentes() {
    const pendentes = registrosLocal.filter(r => !r.synced);
    for (const reg of pendentes) {
      try {
        await supaInsert({
          placa: reg.placa,
          transportadora: reg.transportadora,
          tsISO: reg.ts_iso || reg.tsISO,
          turno: reg.turno,
          diaTurno: reg.dia_turno || reg.diaTurno,
          imagem: reg.imagem || null
        });
        reg.synced = true;
      } catch (e) { console.error(e); }
    }
    salvarRegistrosLocal();
  }

  async function syncNFPendentes() {
    const pendentes = nfLocal.filter(nf => !nf.synced);
    for (const nf of pendentes) {
      try {
        await supaInsertNF({
          placa: nf.placa,
          transportadora: nf.transportadora,
          nf_cancelada: nf.nf_cancelada,
          nf_substituta: nf.nf_substituta,
          motivo_cancelamento: nf.motivo_cancelamento,
          tsISO: nf.ts_iso
        });
        nf.synced = true;
      } catch (e) { console.error(e); }
    }
    salvarNFLocal();
  }

  // ====== PREVIEW IMAGEM ======
  imagemCarreta.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        imgPreviewCarreta.src = ev.target.result;
        previewImagemCarreta.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else { previewImagemCarreta.style.display = "none"; }
  });

  // ====== SALVAR CARRETA ======
  btnSalvarCarreta.addEventListener("click", async () => {
    const placa = (placaModal.value || "").replace(/\s+/g, "").toUpperCase();
    if (!placa) return alert("Informe a placa.");
    const transp = transportadoraModal.value;
    if (!transp) return alert("Selecione a transportadora.");

    const agora = new Date();
    const tsISO = agora.toISOString();
    const info = classificarTurno(agora);

    const salvar = async (img) => {
      const payloadLocal = { placa, transportadora: transp, ts_iso: tsISO, turno: info.turno, dia_turno: info.diaTurno, imagem: img, synced: false };
      registrosLocal.push(payloadLocal);
      salvarRegistrosLocal();
      try {
        await supaInsert({ placa, transportadora: transp, tsISO, turno: info.turno, diaTurno: info.diaTurno, imagem: img });
        setDbStatus(true);
        await syncPendentes();
        alert("Salvo!");
      } catch (e) {
        console.error(e);
        setDbStatus(false);
        alert("Salvo apenas localmente (offline).");
      }
      placaModal.value = ""; transportadoraModal.value = ""; imagemCarreta.value = ""; previewImagemCarreta.style.display = "none"; modalCarreta.style.display = "none";
    };

    if (imagemCarreta.files[0]) {
      const reader = new FileReader();
      reader.onload = (ev) => salvar(ev.target.result);
      reader.readAsDataURL(imagemCarreta.files[0]);
    } else { await salvar(null); }
  });

  // ====== SALVAR NF ======
  btnSalvarNF.addEventListener("click", async () => {
    const placa = (placaNFModal.value || "").replace(/\s+/g, "").toUpperCase();
    if (!placa) return alert("Informe a placa.");
    const transp = transportadoraNFModal.value;
    if (!transp) return alert("Selecione a transportadora.");
    const nfCanc = (nfCanceladaModal.value || "").trim();
    const nfSub = (nfSubstitutaModal.value || "").trim();
    const motivo = (motivoCancelamentoModal.value || "").trim();
    if (!nfCanc || !nfSub || !motivo) return alert("Preencha todos os campos.");

    const agora = new Date();
    const tsISO = agora.toISOString();
    const payloadLocal = { placa, transportadora: transp, nf_cancelada: nfCanc, nf_substituta: nfSub, motivo_cancelamento: motivo, ts_iso: tsISO, synced: false };
    nfLocal.push(payloadLocal);
    salvarNFLocal();

    try {
      await supaInsertNF({ placa, transportadora: transp, nf_cancelada: nfCanc, nf_substituta: nfSub, motivo_cancelamento: motivo, tsISO });
      setDbStatus(true);
      await syncNFPendentes();
      alert("Salvo!");
    } catch (e) {
      console.error(e);
      setDbStatus(false);
      alert("Salvo apenas localmente.");
    }
    placaNFModal.value = ""; transportadoraNFModal.value = ""; nfCanceladaModal.value = ""; nfSubstitutaModal.value = ""; motivoCancelamentoModal.value = ""; modalNF.style.display = "none";
  });

  // ====== MODAL HANDLERS ======
  const setupModal = (btn, modal, close) => {
    if(btn) btn.addEventListener("click", () => modal.style.display = "flex");
    if(close) close.addEventListener("click", () => modal.style.display = "none");
    modal.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
  };
  setupModal(btnAbrirModalCarreta, modalCarreta, btnFecharModalCarreta);
  setupModal(btnAbrirModalNF, modalNF, btnFecharModalNF);
  setupModal(btnAddTranspModal, modalAddTransp, btnFecharAddTransp);
  setupModal(btnAbrirRegistros, modalRegistros, btnFecharRegistros);
  setupModal(btnAbrirNF24h, modalNF24h, btnFecharNF24h);
  setupModal(btnAbrirRelatorio, modalRelatorio, btnFecharRelatorio);
  setupModal(btnAbrirRelatorioNF, modalRelatorioNF, btnFecharRelatorioNF);
  setupModal(null, modalGrafico, btnFecharModalGrafico);
  setupModal(null, modalGraficoNF, btnFecharModalGraficoNF);
  setupModal(null, modalVisualizarImagem, btnFecharModalImagem);

  btnSalvarTransp.addEventListener("click", adicionarTransportadora);

  // ====== CARREGAR DADOS ======
  async function carregarRegistros24h() {
    try {
      await syncPendentes();
      registrosCache = await supaList();
      setDbStatus(true);
    } catch (e) { setDbStatus(false); registrosCache = registrosLocal; }

    const agora = new Date();
    const limite = new Date(agora.getTime() - 24 * 60 * 60 * 1000);
    const filtrados = registrosCache.filter(reg => new Date(reg.ts_iso || reg.tsISO || reg.created_at) >= limite)
      .sort((a, b) => new Date(b.ts_iso || b.tsISO || b.created_at) - new Date(a.ts_iso || a.tsISO || a.created_at));

    tbodyRegistros.innerHTML = filtrados.length ? "" : '<tr><td colspan="7" style="text-align:center;">Nenhum registro.</td></tr>';
    filtrados.forEach((reg, idx) => {
      const d = new Date(reg.ts_iso || reg.tsISO || reg.created_at);
      const info = classificarTurno(d);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${reg.id || (idx+1)}</td><td>${formatarDataHora(d)}</td><td><span class="pill-turno ${info.turno===2?'pill-turno2':''}">T${info.turno}</span></td><td>${reg.placa}</td><td>${reg.transportadora}</td><td class="td-img"></td><td class="td-acoes"></td>`;
      if(reg.imagem) {
        const img = document.createElement("img"); img.src = reg.imagem; img.className = "image-thumbnail";
        img.onclick = () => { imagemGrande.src = reg.imagem; modalVisualizarImagem.style.display = "flex"; };
        tr.querySelector(".td-img").appendChild(img);
      } else { tr.querySelector(".td-img").textContent = "-"; }
      if(reg.id) {
        const btn = document.createElement("button"); btn.className = "btn-delete"; btn.textContent = "Excluir";
        btn.onclick = async () => { if(confirm("Excluir?")) { try { await supaDelete(reg.id); carregarRegistros24h(); } catch(e) { alert("Erro"); } } };
        tr.querySelector(".td-acoes").appendChild(btn);
      }
      tbodyRegistros.appendChild(tr);
    });
  }

  async function carregarNF24h() {
    try { await syncNFPendentes(); nfCache = await supaListNF(); setDbStatus(true); } catch (e) { setDbStatus(false); nfCache = nfLocal; }
    const agora = new Date();
    const limite = new Date(agora.getTime() - 24 * 60 * 60 * 1000);
    const filtrados = nfCache.filter(nf => new Date(nf.ts_iso || nf.tsISO || nf.created_at) >= limite)
      .sort((a, b) => new Date(b.ts_iso || b.tsISO || b.created_at) - new Date(a.ts_iso || a.tsISO || a.created_at));
    tbodyNF24h.innerHTML = filtrados.length ? "" : '<tr><td colspan="7" style="text-align:center;">Nenhum registro.</td></tr>';
    filtrados.forEach((nf, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td><td>${formatarDataHora(new Date(nf.ts_iso || nf.tsISO || nf.created_at))}</td><td>${nf.placa}</td><td>${nf.transportadora}</td><td>${nf.nf_cancelada}</td><td>${nf.nf_substituta}</td><td>${nf.motivo_cancelamento}</td>`;
      tbodyNF24h.appendChild(tr);
    });
  }

  btnAbrirRegistros.addEventListener("click", carregarRegistros24h);
  btnAbrirNF24h.addEventListener("click", carregarNF24h);

  // ====== RELATÓRIOS ======
  const toLocal = (d) => { const off = d.getTimezoneOffset()*60000; return new Date(d.getTime()-off).toISOString().slice(0,16); };
  const initRel = (i, f) => { const agora = new Date(); const ini = new Date(); ini.setDate(agora.getDate()-7); i.value = toLocal(ini); f.value = toLocal(agora); };
  btnAbrirRelatorio.onclick = () => initRel(inicioRel, fimRel);
  btnAbrirRelatorioNF.onclick = () => initRel(inicioRelNF, fimRelNF);

  btnRelatorioPdf.onclick = () => {
    const di = new Date(inicioRel.value), df = new Date(fimRel.value);
    const filtrados = registrosCache.filter(r => { const d = new Date(r.ts_iso || r.tsISO || r.created_at); return d >= di && d <= df; }).sort((a,b) => new Date(a.ts_iso || a.tsISO || a.created_at) - new Date(b.ts_iso || b.tsISO || b.created_at));
    if(!filtrados.length) return alert("Nada encontrado.");
    let html = `<html><head><meta charset="utf-8"><style>body{font-family:sans-serif;background:#020617;color:#e5e7eb;padding:20px;}.card{background:#0f172a;border:1px solid #1f2937;padding:15px;margin-bottom:15px;border-radius:8px;page-break-inside:avoid;}.img{margin-top:10px;text-align:center;}.img img{max-width:100%;max-height:400px;border-radius:8px;}</style></head><body><h2>Relatório Carretas</h2><p>${formatarDataHora(di)} até ${formatarDataHora(df)}</p>`;
    filtrados.forEach((r, i) => {
      const d = new Date(r.ts_iso || r.tsISO || r.created_at); const info = classificarTurno(d);
      html += `<div class="card"><b>#${i+1} - Placa: ${r.placa}</b><br>Transp: ${r.transportadora} | Turno: ${info.turno} | Data: ${formatarDataHora(d)}${r.imagem?`<div class="img"><img src="${r.imagem}"></div>`:''}</div>`;
    });
    html += `</body></html>`;
    const p = window.open("","_blank"); p.document.write(html); p.document.close(); setTimeout(()=>p.print(),500);
  };

  btnRelatorioPdfNF.onclick = () => {
    const di = new Date(inicioRelNF.value), df = new Date(fimRelNF.value);
    const filtrados = nfCache.filter(r => { const d = new Date(r.ts_iso || r.tsISO || r.created_at); return d >= di && d <= df; }).sort((a,b) => new Date(a.ts_iso || a.tsISO || a.created_at) - new Date(b.ts_iso || b.tsISO || b.created_at));
    if(!filtrados.length) return alert("Nada encontrado.");
    let html = `<html><head><meta charset="utf-8"><style>body{font-family:sans-serif;background:#020617;color:#e5e7eb;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #1f2937;padding:8px;text-align:left;}th{background:#0f172a;}</style></head><body><h2>Relatório NF</h2><table><thead><tr><th>Data</th><th>Placa</th><th>NF Canc</th><th>NF Subst</th><th>Motivo</th></tr></thead><tbody>`;
    filtrados.forEach(r => { html += `<tr><td>${formatarDataHora(new Date(r.ts_iso || r.tsISO || r.created_at))}</td><td>${r.placa}</td><td>${r.nf_cancelada}</td><td>${r.nf_substituta}</td><td>${r.motivo_cancelamento}</td></tr>`; });
    html += `</tbody></table></body></html>`;
    const p = window.open("","_blank"); p.document.write(html); p.document.close(); setTimeout(()=>p.print(),500);
  };

  // ====== GRÁFICOS ======
  let c1=null, c2=null;
  btnGrafico7d.onclick = () => {
    const base = registrosCache; if(!base.length) return;
    const labels=[], data=[]; const hoje=new Date(); for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(hoje.getDate()-i); const k=`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; labels.push(`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`); data.push(base.filter(r=>(r.dia_turno||r.diaTurno)===k).length); }
    if(c1) c1.destroy(); c1 = new Chart(canvasGrafico, { type:'bar', data:{ labels, datasets:[{label:'Carretas',data,backgroundColor:'#0ea5e9'}] }, options:{responsive:true} });
    modalGrafico.style.display='flex';
  };
  btnGrafico7dNF.onclick = () => {
    const base = nfCache; if(!base.length) return;
    const labels=[], data=[]; const hoje=new Date(); for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(hoje.getDate()-i); const k=`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; labels.push(`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`); data.push(base.filter(r=>{const dt=new Date(r.ts_iso||r.tsISO||r.created_at); return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`===k;}).length); }
    if(c2) c2.destroy(); c2 = new Chart(canvasGraficoNF, { type:'bar', data:{ labels, datasets:[{label:'NF',data,backgroundColor:'#8C75C7'}] }, options:{responsive:true} });
    modalGraficoNF.style.display='flex';
  };

  // ====== INIT ======
  carregarTransportadoras(); carregarRegistrosLocal(); carregarNFLocal();
  (async () => { try { await syncPendentes(); await syncNFPendentes(); registrosCache = await supaList(); nfCache = await supaListNF(); setDbStatus(true); } catch (e) { setDbStatus(false); } })();
</script>
</body>
</html>
