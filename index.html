<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>S-systems</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
body{margin:0;font-family:Arial;background:#111827;color:#e5e7eb;padding:16px}
h1,h2{margin:0 0 8px}
.card{background:#0f172a;border:1px solid #334155;border-radius:14px;padding:16px;margin-bottom:16px}
label{font-size:13px;color:#94a3b8}
input,select{width:100%;padding:8px;margin-top:4px;background:#020617;border:1px solid #334155;color:#e5e7eb;border-radius:8px}
button{padding:10px 16px;border:none;border-radius:999px;cursor:pointer;font-weight:bold}
.btn-primary{background:#0ea5e9;color:#020617}
.btn-ghost{background:#020617;color:#0ea5e9;border:1px solid #334155}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #334155;padding:6px;font-size:12px}
th{background:#020617;color:#94a3b8}
.img-box{border:3px solid #000;height:260px;margin:10px 0;display:flex;align-items:center;justify-content:center}
.img-box img{max-width:100%;max-height:100%;object-fit:contain}
.no-img{font-size:18px}
</style>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://rficsflnaxayyrddxald.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_5oVEei3ZTGog0ycrbBbs2w_oDImnx9K";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== UTIL =====
const pad2 = x => String(x).padStart(2,"0");
const fmt = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

// ===== IMAGEM (COLAR / FILE) =====
let imagemColada = null;
document.addEventListener("paste", e=>{
  const items = e.clipboardData?.items || [];
  for(const it of items){
    if(it.type.startsWith("image/")){
      imagemColada = it.getAsFile();
      alert("Imagem colada com sucesso");
    }
  }
});

// ===== HTML =====
</script>
</head>

<body>

<h1>PAINEL BÁSCULA – CONTAMINAÇÃO</h1>

<div class="card">
  <h2>Registrar carreta</h2>

  <label>Placa</label>
  <input id="placa">

  <label>Transportadora</label>
  <input id="transportadora">

  <label>Imagem da contaminação (JPEG)</label>
  <input type="file" id="imgFile" accept="image/jpeg">

  <br><br>
  <button class="btn-primary" id="btnSalvar">Registrar caminhão sujo</button>
</div>

<div class="card">
  <h2>Relatório</h2>
  <label>Início</label>
  <input type="datetime-local" id="di">
  <label>Fim</label>
  <input type="datetime-local" id="df">
  <br><br>
  <button class="btn-primary" id="btnPdf">PDF simples</button>
  <button class="btn-ghost" id="btnPdfImg">PDF COM IMAGENS</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://rficsflnaxayyrddxald.supabase.co",
  "sb_publishable_5oVEei3ZTGog0ycrbBbs2w_oDImnx9K"
);

async function uploadImagem(file, registroId){
  const name = `bascula_${registroId}_${Date.now()}.jpg`;
  await supabase.storage.from("bascula-contaminacao")
    .upload(name, file, { contentType:"image/jpeg" });

  await supabase.from("registros_bascula_imagens")
    .insert([{ registro_id: registroId, image_path: name }]);
}

document.getElementById("btnSalvar").onclick = async ()=>{
  const placa = placaInput.value = placa.value.toUpperCase();
  const transportadoraVal = transportadora.value;
  if(!placa || !transportadoraVal) return alert("Preencha tudo");

  const { data } = await supabase
    .from("registros_bascula")
    .insert([{ placa, transportadora: transportadoraVal, ts: new Date().toISOString() }])
    .select("id")
    .single();

  const img = imagemColada || imgFile.files[0];
  if(img) await uploadImagem(img, data.id);

  imagemColada = null;
  imgFile.value = "";
  placa.value = "";
  transportadora.value = "";

  alert("Registro salvo com imagem");
};

async function gerarPdf(comImagem){
  const di = new Date(document.getElementById("di").value);
  const df = new Date(document.getElementById("df").value);

  const { data: regs } = await supabase
    .from("registros_bascula")
    .select("*")
    .gte("ts", di.toISOString())
    .lte("ts", df.toISOString())
    .order("ts");

  const ids = regs.map(r=>r.id);
  let imgMap = {};

  if(comImagem){
    const { data: imgs } = await supabase
      .from("registros_bascula_imagens")
      .select("*")
      .in("registro_id", ids);

    imgs.forEach(i=>{
      if(!imgMap[i.registro_id]) imgMap[i.registro_id]=[];
      imgMap[i.registro_id].push(i.image_path);
    });
  }

  let html = `<html><body><h2>Relatório Báscula</h2>`;

  regs.forEach((r,i)=>{
    html+=`
    <table>
      <tr><th>#</th><th>Placa</th><th>Transportadora</th><th>Data</th></tr>
      <tr><td>${i+1}</td><td>${r.placa}</td><td>${r.transportadora}</td><td>${fmt(new Date(r.ts))}</td></tr>
    </table>
    `;
    if(comImagem){
      const imgs = imgMap[r.id]||[];
      if(imgs.length){
        imgs.forEach(p=>{
          html+=`<div class="img-box"><img src="${SUPABASE_URL}/storage/v1/object/public/bascula-contaminacao/${p}"></div>`;
        });
      }else{
        html+=`<div class="img-box"><div class="no-img">SEM IMAGEM</div></div>`;
      }
    }
  });

  html+=`</body></html>`;
  const w = window.open();
  w.document.write(html);
  w.document.close();
  setTimeout(()=>w.print(),500);
}

btnPdf.onclick = ()=>gerarPdf(false);
btnPdfImg.onclick = ()=>gerarPdf(true);
</script>

</body>
</html>
